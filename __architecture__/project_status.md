# API Migration Project Plan

Status Legend:
âœ… Done | ðŸš§ In Progress | âŒ› Not Started | âŒ Blocked | ðŸ”œ Do This Next

## Phase 1: Database Updates
Status: âœ… Done
1. Add missing indexes âœ…
   - Index on topics(user_id)
2. Rename users.role column to users.roles âœ…
3. Document roles âœ…
   - role_user: Default role for all users
   - role_admin: Required for /admin access
4. Verify all needed cascade deletes are in place âœ…
5. Remove duplicate 'role' field from users table (use 'roles' field only) âœ…
6. Document database schema in XML format âœ…
7. Design AI agent user system ðŸ”œ
   - Create special user accounts for AI agents (lesson_teacher, lesson_plan)
   - Support for multiple teacher personalities:
     - Different teaching styles (e.g., Socratic, direct, encouraging)
     - Specialized subject matter experts
     - Various difficulty levels
   - Future agent types to consider:
     - study_buddy: Peer-like agent for collaborative learning
     - mentor: Long-term progress tracking and guidance
     - expert_reviewer: Specialized in giving detailed feedback
   - Each agent will have:
     - Unique user_id prefix (e.g., teacher_*, mentor_*)
     - Custom avatar/icon
     - Personality description
     - Specialized knowledge areas
     - Preferred teaching methods

## Phase 2: Authentication Setup
Status: âœ… Done
1. Implement JWT authentication âœ…
   - Token generation and validation âœ…
   - User registration endpoint âœ…
   - User login endpoint âœ…
   - /me endpoint âœ…
2. Add user management âœ…
   - Session handling âœ…
   - Connection timeouts âœ…
   - Error handling âœ…
3. Set up auth middleware âœ…
4. Add user session handling âœ…
5. Define token storage strategy âœ…
   - Using JWT in Authorization header

## Phase 3: Project Structure Setup
Status: âœ… Done
1. Reorganized project into new structure:
   - frontend/ directory: React frontend code
   - backend/ directory: FastAPI backend code
   - shared/ directory: Shared types and utilities
   - Root package.json for workspace management
2. Updated package.json files for each workspace
3. Moved code to appropriate directories
4. Set up shared types and utilities

## Phase 4: Backend Development
Status: âœ… Done
1. Initialize backend Express server âœ…
2. Move and adapt database code âœ…
3. Set up middleware: âœ…
   - CORS âœ…
   - Request logging âœ…
   - Error handling âœ…
   - Rate limiting âœ…
   - Define rate limiting strategy per endpoint âœ…

## Phase 5: API Implementation
Status: âœ… Done
1. Define API versioning approach: âœ…
   - Use /api/v1 prefix for all endpoints âœ…
   - Document version header handling âœ…

### Endpoints

API Base Path: /api/v1

Auth:
- POST   /auth/register     - Register new user âœ…
- POST   /auth/login        - Login user âœ…
- POST   /auth/logout       - Logout user âœ…
- GET    /auth/me           - Get current user âœ…

Users (Admin):
- GET    /users            - List users âœ…
- PUT    /users/:id        - Update user âœ…
- DELETE /users/:id        - Delete user âœ…

Topics:
- GET    /topics        - List topics âœ…
- POST   /topics        - Create topic (admin) âœ…
- GET    /topics/:id    - Get topic âœ…
- PUT    /topics/:id    - Update topic (admin) âœ…
- DELETE /topics/:id    - Delete topic + cascade (admin) âœ…

Questions:
- GET    /questions/topic/:id  - Get questions for topic âœ…
- POST   /questions           - Create question (admin) âœ…
- PUT    /questions/:id       - Update question (admin) âœ…

Progress:
- GET    /progress/topic/:id  - Get progress for topic âœ…
- POST   /progress           - Record progress âœ…

### Response Formats
1. Success Response Structure âœ…
2. Error Response Codes and Formats âœ…
3. Pagination Format âœ…

## Phase 6: Frontend Development
Status: âœ… Done

### Infrastructure Setup
1. API Client Integration âœ…
   - Create frontend/src/lib/api.ts âœ…
   - Configure API client with environment variables âœ…
   - Export service instances (auth, topics, questions, progress) âœ…
   - Add request/response interceptors âœ…
   - Add error handling middleware âœ…

2. State Management âœ…
   - Create AuthContext for user state âœ…
   - Create LoadingContext for API states âœ…
   - Add token management âœ…
   - Add persistent login âœ…
   - Add auto-refresh token logic âœ…

3. Error Handling âœ…
   - Create error handling utilities âœ…
   - Create useAsync hook for API calls âœ…
   - Add error boundary components âœ…
   - Integrate toast notifications âœ…
     - Toast context and hooks âœ…
     - Toast container component âœ…
     - Toast styling âœ…
     - Integration with error handling âœ…
   - Add API error type definitions âœ…
   - Add error logging âœ…

4. Environment Setup âœ…
   - Configure frontend environment variables âœ…
   - Add environment type definitions âœ…
   - Set up environment switching (dev/test/prod) âœ…
   - Add environment validation âœ…
   - Create environment examples âœ…

### Component Implementation
1. Create API client service âœ…
   - Base client implementation âœ…
   - Auth service âœ…
   - Topics service âœ…
   - Questions service âœ…
   - Progress service âœ…

2. Add validation schemas âœ…
   - Auth validation âœ…
   - Topics validation âœ…
   - Questions validation âœ…
   - Progress validation âœ…

3. Create UI Components âœ…
   - Progress component âœ…
   - Badge component âœ…
   - Button component âœ…
   - Input component âœ…
   - Textarea component âœ…
   - Card component âœ…
   - Dropdown Menu components âœ…
   - Error Message component âœ…

4. Update existing components âœ…
   - Convert DB calls to API calls âœ…
   - Add loading states âœ…
   - Add error handling âœ…
   - Integrate validation schemas âœ…
   - Update UI components with new design system âœ…
   - Connect delete functionality âœ…
   - Connect update functionality âœ…

5. Add authentication UI âœ…
   - Login form âœ…
   - Registration form âœ…
   - Password reset flow âŒ›
   - Profile management âœ…
   - Protected routes âœ…
   - Role-based access control âœ…

## Phase 7: Future Enhancements
Status: ðŸš§ In Progress

### Development
1. Configure nodemon âœ…
2. Set up concurrent frontend/backend development âœ…
3. Configure debugging âœ…
4. Set up API documentation generation ðŸš§
5. Set up request validation âœ…
6. Configure production logging ðŸš§

### Features
1. Password reset functionality âŒ›
2. Email verification âŒ›
3. Sorting/Filtering for API endpoints âœ…
4. API versioning âœ…
5. Offline support âŒ›
6. Error boundary handling âœ…
7. Request retry logic âœ…

### Database
1. Add audit fields (created_by, updated_by) âœ…
2. Database backup strategy ðŸš§

### Error Monitoring System
1. Implement secure error logging system for production
   - Capture frontend console errors and logs
   - Secure API endpoint for error reporting
   - Authentication and rate limiting for error submissions
   - Database storage for error logs
   - AI-powered error analysis and auto-fixing capabilities
   - Security considerations:
     - Prevent unauthorized access to error logs
     - Sanitize error data to prevent XSS
     - Rate limiting to prevent abuse
     - Secure storage of sensitive information

### Security Enhancements
Status: ðŸ”œ Do This Next
1. Account Security
   - Implement account lockout after multiple failed attempts âŒ›
   - Configure lockout duration and attempt threshold âŒ›
   - Add user notification for account lockouts âŒ›
   - Add admin interface for managing locked accounts âŒ›
2. Password Security
   - Implement password complexity requirements âŒ›
   - Add password expiration policy âŒ›
   - Prevent password reuse âŒ›
3. Session Security
   - Implement session timeout âœ…
   - Add concurrent session handling âŒ›
   - Add session activity logging âŒ›

### UI/UX Improvements
Status: ðŸš§ In Progress
1. Learning Progress Interface
   - Remove redundant UI elements âœ…
   - Improve card layout and spacing âœ…
   - Add progress visualization âœ…
2. Navigation
   - Implement breadcrumbs âŒ›
   - Add quick navigation shortcuts âŒ›
3. Accessibility
   - Add ARIA labels âŒ›
   - Implement keyboard navigation âŒ›
   - Add high contrast mode âŒ›

## Phase 8: Database Schema Overhaul
Status: âœ… Done

### Database Schema Details

1. Core Content Tables
   - `topic_lessons` âœ…
     ```sql
     CREATE TABLE topic_lessons (
       lesson_id INTEGER PRIMARY KEY,
       topic_id INTEGER NOT NULL,
       title TEXT NOT NULL,
       content TEXT NOT NULL,
       order_index INTEGER NOT NULL,
       parent_lesson_id INTEGER,
       created_at INTEGER NOT NULL,
       updated_at INTEGER NOT NULL,
       FOREIGN KEY (topic_id) REFERENCES topics(topic_id) ON DELETE CASCADE,
       FOREIGN KEY (parent_lesson_id) REFERENCES topic_lessons(lesson_id) ON DELETE SET NULL
     );
     CREATE INDEX idx_topic_lessons_topic ON topic_lessons(topic_id);
     CREATE INDEX idx_topic_lessons_parent ON topic_lessons(parent_lesson_id);
     ```

2. User Learning Data Tables
   - `user_lesson_progress` âœ…
     ```sql
     CREATE TABLE user_lesson_progress (
       progress_id INTEGER PRIMARY KEY,
       user_id INTEGER NOT NULL,
       lesson_id INTEGER NOT NULL,
       status TEXT NOT NULL CHECK (status IN ('not_started', 'in_progress', 'completed')),
       last_interaction_at INTEGER NOT NULL,
       completion_date INTEGER,
       FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
       FOREIGN KEY (lesson_id) REFERENCES topic_lessons(lesson_id) ON DELETE CASCADE
     );
     CREATE INDEX idx_lesson_progress_user ON user_lesson_progress(user_id);
     CREATE INDEX idx_lesson_progress_lesson ON user_lesson_progress(lesson_id);
     ```

### Component Updates

1. Existing Component Updates

   a. LearningTree Component âœ…
   ```typescript
   interface LearningTreeProps {
     topic: Topic;
     lessons: TopicLesson[];          // Was questions
     userProgress: UserLessonProgress[]; // Was userProgress
   }
   ```
   Changes Needed:
   - Update data fetching to use new lesson endpoints âœ…
   - Modify tree rendering to handle parent/child relationships âœ…
   - Update progress indicators to use new status enum âœ…
   - Keep same UI/UX patterns âœ…

   b. TopicLearning Component âœ…
   ```typescript
   // Main container component
   // Updates needed:
   - Replace question loading with lesson loading âœ…
   - Update progress tracking to use new endpoints âœ…
   - Keep same layout structure âœ…
   ```

2. New Components

   a. LessonContent Component âœ…
   ```typescript
   interface LessonContentProps {
     lesson: TopicLesson;
     progress: UserLessonProgress;
     onProgressUpdate: (status: ProgressStatus) => void;
   }
   ```
   Features:
   - Displays lesson content âœ…
   - Shows/manages progress status âœ…
   - Handles lesson completion âœ…

### Backend Updates

1. Model Updates âœ…
   ```typescript
   // models/TopicLesson.ts
   interface TopicLesson {
     lesson_id: number;
     topic_id: number;
     title: string;
     content: string;
     order_index: number;
     parent_lesson_id: number | null;
     created_at: number;
     updated_at: number;
     children?: TopicLesson[];
   }

   // models/UserLessonProgress.ts
   interface UserLessonProgress {
     progress_id: number;
     user_id: number;
     lesson_id: number;
     status: 'not_started' | 'in_progress' | 'completed';
     last_interaction_at: number;
     completion_date: number | null;
   }
   ```

2. API Routes âœ…
   ```typescript
   // routes/lessons.ts
   router.get('/api/v1/topics/:topicId/lessons', getLessonsForTopic);
   router.post('/api/v1/topics/:topicId/lessons', createLesson);
   router.put('/api/v1/lessons/:lessonId', updateLesson);
   router.delete('/api/v1/lessons/:lessonId', deleteLesson);
   router.post('/api/v1/topics/:topicId/lessons/reorder', reorderLessons);

   // routes/progress.ts - All require authenticated user
   router.get('/api/v1/users/me/lessons/:lessonId/progress', getUserLessonProgress);
   router.put('/api/v1/users/me/lessons/:lessonId/progress', updateUserLessonProgress);
   router.get('/api/v1/users/me/topics/:topicId/progress', getUserTopicProgress);
   ```

### Implementation Plan

1. Database Setup âœ…
   - Create new tables âœ…
   - Add indexes and constraints âœ…
   - Verify schema integrity âœ…

2. Backend Implementation âœ…
   - Create new models and types âœ…
   - Implement lesson endpoints âœ…
   - Add progress tracking endpoints âœ…
   - Add validation and error handling âœ…
   - Write tests for new functionality âœ…

3. Frontend Updates âœ…
   - Update types and interfaces âœ…
   - Modify LearningTree component âœ…
   - Create LessonContent component âœ…
   - Update TopicLearning container âœ…
   - Update progress tracking âœ…
   - Test all interactions âœ…

4. Testing Strategy âœ…
   - Unit tests for new models âœ…
   - API endpoint testing âœ…
   - Component integration tests âœ…
   - End-to-end user flow testing âœ…
   - Performance testing for new queries âœ…

## Phase 9: Chat Integration
Status: ðŸš§ In Progress

### Overview
Implement AI-powered chat functionality for interactive learning experiences. Chat history will be stored in the `user_topic_lessons` table as a JSON blob in the `chat_history` field.

### Implementation Details
1. LLM Integration Strategy:
    *   Choose an LLM service (e.g., OpenAI's GPT-3, a custom model).
    *   Plan how the LLM service will be integrated into the backend (SDK, API calls, etc.).
    *   Define authentication and API request/response handling.
2. Design the Chat Interface:
    *   Plan the UI/UX for the `ChatInterface` component.
    *   Define message display, input handling, and additional features (timestamps, user avatars, loading indicators).
3. Backend Logic:
    *   Implement `getUserLessonChat` API route to fetch chat history from `user_topic_lessons.chat_history`.
    *   Implement `addUserLessonChat` API route to update `user_topic_lessons.chat_history` with new messages.
    *   Integrate with the chosen LLM service to send user messages and receive AI responses.
    *   Handle data transformation and formatting between the application and the LLM service.
4. Create Frontend Components:
    *   Develop the `ChatInterface` component based on the design.
    *   Implement `Message display` and `Input handling` sub-components.
5. Integrate Frontend and Backend:
    *   Connect frontend components to API routes for sending and receiving messages.
    *   Implement real-time updates using technologies like WebSockets.

### Components to Add
   - ChatInterface component
   - Message display
   - Input handling
   - Integration with LLM service (details TBD)

### API Routes
   ```typescript
   router.get('/api/v1/users/me/lessons/:lessonId/chat', getUserLessonChat);
   router.post('/api/v1/users/me/lessons/:lessonId/chat', addUserLessonChat);
   ```

Details of LLM integration and specific chat features will be defined when we reach this phase.

## Testing Strategy
Status: âœ… Done
1. Unit tests for validation schemas âœ…
   - Auth validation âœ…
   - Topics validation âœ…
   - Questions validation âœ…
   - Progress validation âœ…
2. Unit tests for API client âœ…
   - Base client tests âœ…
   - Auth service tests âœ…
   - Topics service tests âœ…
   - Questions service tests âœ…
   - Progress service tests âœ…
3. Unit tests for API endpoints âœ…
   - Auth endpoints âœ…
     - User registration (success/failure) âœ…
     - User login (success/failure) âœ…
     - Session management âœ…
     - /me endpoint âœ…
   - Topics endpoints âœ…
     - List topics (user/admin) âœ…
     - Create topic (permissions) âœ…
     - Update/delete (ownership) âœ…
   - Questions endpoints âœ…
     - Get questions for topic âœ…
       - Test user ownership check âœ…
       - Test admin access âœ…
       - Test invalid topic ID âœ…
       - Test empty topic âœ…
     - Create question âœ…
       - Test admin-only access âœ…
       - Test option validation âœ…
       - Test correct answer validation âœ…
       - Test invalid topic ID âœ…
     - Update question âœ…
       - Test admin-only access âœ…
       - Test option validation âœ…
       - Test invalid question ID âœ…
   - Progress endpoints âœ…
     - Get topic progress âœ…
       - Test user ownership check âœ…
       - Test admin access âœ…
       - Test invalid topic ID âœ…
       - Test progress calculation âœ…
     - Record progress âœ…
       - Test user ownership check âœ…
       - Test invalid topic ID âœ…
       - Test invalid question ID âœ…
       - Test question-topic mismatch âœ…
4. Integration tests for database operations âœ…
   - Auth operations âœ…
   - Topic operations âœ…
   - Question operations âœ…
     - Test cascade deletes âœ…
     - Test JSON option storage âœ…
     - Test ordering by created_at âœ…
   - Progress operations âœ…
     - Test progress recording âœ…
     - Test progress aggregation âœ…
     - Test cascade deletes âœ…
5. Authentication flow testing âœ…
   - Registration flow âœ…
   - Login flow âœ…
   - Session validation âœ…
6. Frontend integration testing âœ…

## Deployment Considerations
Status: ðŸš§ In Progress
1. Update build scripts âœ…
2. Environment variable management âœ…
3. Database migration process âœ…
4. API documentation deployment ðŸš§

## Testing & Deployment
Status: ðŸš§ In Progress
1. End-to-end testing ðŸš§
   - Auth flow tests âœ…
   - Session cleanup âœ…
2. Cross-browser testing âŒ›
3. Load testing âŒ›
4. Zero-downtime deployment âŒ›
5. Monitoring setup âŒ›
6. Error tracking setup âŒ›
7. Backup strategy âŒ›
8. Rollback procedures âŒ›
